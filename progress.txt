# Zerobrew Development Progress

**Date**: 2026-01-26
**Branch**: linux-compat

---

## Session Summary

This session focused on PR review, code quality improvements, and starting Phase 1 implementation.

---

## Completed Tasks

### 1. Comprehensive PR Review
- Ran 4 specialized review agents in parallel (code-reviewer, test-analyzer, silent-failure-hunter, code-simplifier)
- Identified 5 important issues and 4 suggestions

### 2. Fixed All Review Issues

**Silent Failure Warnings Added:**
- `materialize.rs:468-471` - Warning when patchelf unavailable
- `materialize.rs:616-638` - Log patchelf failures with stderr
- `install.rs:91` - Warning when dependencies skipped (no compatible bottle)
- `install.rs:228` - Warning when formulas skipped (not found)
- `resolve.rs:71` - Warning when unavailable dependencies skipped
- `api.rs:112` - Warning on cache write failures

**Test Coverage Improvements:**
- Fixed `handles_broken_symlinks` test to assert behavior
- Fixed `handles_circular_symlinks` test to assert behavior
- Added `patches_rpath_without_changing_valid_interpreter` test
- Added `install_skips_macos_only_uses_from_macos_deps` test

**Code Quality Refactoring:**
- Extracted shared `patch_homebrew_path()` function (eliminates 35+ lines duplication)
- Added `WriteGuard` RAII pattern for permission handling (eliminates ~45 lines)
- Simplified `is_compatible_fallback_tag()` - flattened nested #[cfg] blocks
- Added `store_err()` helper for error mapping
- Refactored `create_or_find_patchable_binary()` with iterator combinators

### 3. Created Comprehensive Roadmap
- Wrote `ROADMAP.md` with 5 phases to full Homebrew replacement
- Phase 1 (v0.5): Daily Driver - search, outdated, upgrade, pin, autoremove, shellenv
- Phase 2 (v0.7): Power User - taps, formula parser, doctor
- Phase 3 (v0.8): Services - systemd/launchd
- Phase 4 (v1.0): Source builds
- Phase 5 (v1.x): Ecosystem - bundle, versioned formulas

### 4. Implemented Search Command (Phase 1.1) ✅

**Files created/modified:**
- `zb_io/src/search.rs` (NEW) - Search module with relevance scoring
- `zb_io/src/api.rs` - Added `get_all_formulas()` and `FormulaInfo` type
- `zb_io/src/lib.rs` - Exported search module
- `zb_cli/src/main.rs` - Added `zb search` command

**Features:**
- Plain text search (matches name and description)
- Regex search with `/pattern/` syntax
- Relevance scoring (exact match > prefix > contains > description)
- Shows installed packages with ✓ marker
- Excludes deprecated and disabled formulas
- Limits output to top 20 results

**Example usage:**
```
$ zb search git
==> Found 245 formulas:
✓ git 2.52.0
    Distributed revision control system
  git-absorb 0.8.0
    Automatic git commit --fixup
  ...

$ zb search '/python@3\.1[12]/'
==> Found 2 formulas:
  python@3.11 3.11.14
  python@3.12 3.12.12
```

---

## Commits Created

1. `d3cf8ed` - refactor: Improve error reporting and code quality
2. `f5ed76b` - docs: Add comprehensive roadmap for full Homebrew replacement

### 5. Implemented Outdated Command (Phase 1.2) ✅

**Files created/modified:**
- `zb_core/src/version.rs` (NEW) - Version parsing and comparison
- `zb_core/src/lib.rs` - Exported version module
- `zb_io/src/install.rs` - Added `get_outdated()` method to Installer
- `zb_cli/src/main.rs` - Added `zb outdated` command
- `zb_cli/Cargo.toml` - Added serde_json dependency

**Features:**
- Compares installed package versions against latest API versions
- Handles Homebrew version formats including:
  - Simple versions: `1.2.3`
  - Rebuild suffixes: `1.0.0_1`
  - Prerelease: `1.0.0-beta` (properly sorts before `1.0.0`)
- Supports `--json` flag for machine-readable output
- Shows helpful upgrade hint in human-readable output
- Parallel API fetching for all installed packages

**Example usage:**
```
$ zb outdated
==> Checking for outdated packages...
==> 3 outdated packages:

  git 2.43.0 → 2.44.0
  node 20.11.0 → 21.6.0
  python@3.11 3.11.7 → 3.11.8

    → Run zb upgrade to upgrade all

$ zb outdated --json
[
  {
    "name": "git",
    "installed_version": "2.43.0",
    "available_version": "2.44.0"
  }
]
```

### 6. Implemented Upgrade Command (Phase 1.3) ✅

**Files modified:**
- `zb_io/src/install.rs` - Added `upgrade_one()`, `upgrade_all()` methods and `UpgradeResult` type
- `zb_io/src/lib.rs` - Exported `UpgradeResult`
- `zb_cli/src/main.rs` - Added `zb upgrade` command

**Features:**
- Upgrade all outdated packages: `zb upgrade`
- Upgrade specific package: `zb upgrade <formula>`
- Dry-run mode: `zb upgrade --dry-run`
- Progress display with download/unpack/link status
- Automatic removal of old version after successful upgrade
- Continues with other packages if one fails
- Displays summary of upgraded packages with old/new versions

**Implementation details:**
- Uses existing `get_outdated()` to find packages needing upgrade
- For each package: unlinks old version, installs new version, removes old keg
- Database automatically updated via INSERT OR REPLACE
- Reuses existing install flow with progress callbacks
- Version comparison using `Version::is_older_than()`

**Example usage:**
```
$ zb upgrade --dry-run
==> Would upgrade 2 packages:

  git 2.43.0 → 2.44.0
  ripgrep 14.0.0 → 14.1.0

$ zb upgrade
==> Upgrading 2 packages...

==> Upgrading git 2.43.0 → 2.44.0...
    git              ━━━━━━━━━━━━━━━ 10.5MB/10.5MB  0s
    git              ✓ upgraded

==> Upgrading ripgrep 14.0.0 → 14.1.0...
    ripgrep          ✓ upgraded

==> Upgraded 2 packages in 3.45s:
    ✓ git 2.43.0 → 2.44.0
    ✓ ripgrep 14.0.0 → 14.1.0

$ zb upgrade git
==> git is already up to date.
```

**New tests (6 total):**
- `upgrade_installs_new_version_and_removes_old` - Tests full upgrade flow
- `upgrade_returns_none_when_up_to_date` - Tests no-op when current
- `upgrade_not_installed_returns_error` - Tests error on uninstalled package
- `upgrade_all_upgrades_multiple_packages` - Tests upgrading multiple packages at once
- `upgrade_all_empty_when_all_current` - Tests empty result when all up-to-date
- `upgrade_preserves_links` - Tests symlinks point to new version after upgrade

---

## Remaining Phase 1 Tasks

| Task | Status |
|------|--------|
| 1.1 Search command | ✅ Complete |
| 1.2 Outdated command | ✅ Complete |
| 1.3 Upgrade command | ✅ Complete |
| 1.4 Pin/unpin commands | ⏳ Not started |
| 1.5 Autoremove command | ⏳ Not started |
| 1.6 Shellenv command | ⏳ Not started |
| 1.7 Improved info command | ⏳ Not started |

---

## Test Results

All tests passing:
- 142 unit tests passed (37 zb_core + 105 zb_io)
- 27 integration tests passed
- 4 tests ignored (require specific environment)

---

## Next Steps

1. Implement `zb pin/unpin` - prevent specific packages from upgrading
2. Implement `zb autoremove` - remove orphaned dependencies
3. Implement `zb shellenv` - output shell environment setup
4. Improve `zb info` - show dependencies, caveats, etc.

---

## Notes

- Search command fetches ~7MB formula.json on first run (cached after)
- Outdated command fetches individual formula JSON for each installed package
- Consider adding `--json` flag to search for machine-readable output
- May want to add search filters (e.g., `--installed-only`)
- Upgrade command reuses install progress display for consistency
