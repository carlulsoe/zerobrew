# Zerobrew Development Progress

**Date**: 2026-01-26
**Branch**: linux-compat

---

## Session Summary

This session focused on PR review, code quality improvements, and starting Phase 1 implementation.

---

## Completed Tasks

### 1. Comprehensive PR Review
- Ran 4 specialized review agents in parallel (code-reviewer, test-analyzer, silent-failure-hunter, code-simplifier)
- Identified 5 important issues and 4 suggestions

### 2. Fixed All Review Issues

**Silent Failure Warnings Added:**
- `materialize.rs:468-471` - Warning when patchelf unavailable
- `materialize.rs:616-638` - Log patchelf failures with stderr
- `install.rs:91` - Warning when dependencies skipped (no compatible bottle)
- `install.rs:228` - Warning when formulas skipped (not found)
- `resolve.rs:71` - Warning when unavailable dependencies skipped
- `api.rs:112` - Warning on cache write failures

**Test Coverage Improvements:**
- Fixed `handles_broken_symlinks` test to assert behavior
- Fixed `handles_circular_symlinks` test to assert behavior
- Added `patches_rpath_without_changing_valid_interpreter` test
- Added `install_skips_macos_only_uses_from_macos_deps` test

**Code Quality Refactoring:**
- Extracted shared `patch_homebrew_path()` function (eliminates 35+ lines duplication)
- Added `WriteGuard` RAII pattern for permission handling (eliminates ~45 lines)
- Simplified `is_compatible_fallback_tag()` - flattened nested #[cfg] blocks
- Added `store_err()` helper for error mapping
- Refactored `create_or_find_patchable_binary()` with iterator combinators

### 3. Created Comprehensive Roadmap
- Wrote `ROADMAP.md` with 5 phases to full Homebrew replacement
- Phase 1 (v0.5): Daily Driver - search, outdated, upgrade, pin, autoremove, shellenv
- Phase 2 (v0.7): Power User - taps, formula parser, doctor
- Phase 3 (v0.8): Services - systemd/launchd
- Phase 4 (v1.0): Source builds
- Phase 5 (v1.x): Ecosystem - bundle, versioned formulas

### 4. Implemented Search Command (Phase 1.1) âœ…

**Files created/modified:**
- `zb_io/src/search.rs` (NEW) - Search module with relevance scoring
- `zb_io/src/api.rs` - Added `get_all_formulas()` and `FormulaInfo` type
- `zb_io/src/lib.rs` - Exported search module
- `zb_cli/src/main.rs` - Added `zb search` command

**Features:**
- Plain text search (matches name and description)
- Regex search with `/pattern/` syntax
- Relevance scoring (exact match > prefix > contains > description)
- Shows installed packages with âœ“ marker
- Excludes deprecated and disabled formulas
- Limits output to top 20 results

**Example usage:**
```
$ zb search git
==> Found 245 formulas:
âœ“ git 2.52.0
    Distributed revision control system
  git-absorb 0.8.0
    Automatic git commit --fixup
  ...

$ zb search '/python@3\.1[12]/'
==> Found 2 formulas:
  python@3.11 3.11.14
  python@3.12 3.12.12
```

---

## Commits Created

1. `d3cf8ed` - refactor: Improve error reporting and code quality
2. `f5ed76b` - docs: Add comprehensive roadmap for full Homebrew replacement

### 5. Implemented Outdated Command (Phase 1.2) âœ…

**Files created/modified:**
- `zb_core/src/version.rs` (NEW) - Version parsing and comparison
- `zb_core/src/lib.rs` - Exported version module
- `zb_io/src/install.rs` - Added `get_outdated()` method to Installer
- `zb_cli/src/main.rs` - Added `zb outdated` command
- `zb_cli/Cargo.toml` - Added serde_json dependency

**Features:**
- Compares installed package versions against latest API versions
- Handles Homebrew version formats including:
  - Simple versions: `1.2.3`
  - Rebuild suffixes: `1.0.0_1`
  - Prerelease: `1.0.0-beta` (properly sorts before `1.0.0`)
- Supports `--json` flag for machine-readable output
- Shows helpful upgrade hint in human-readable output
- Parallel API fetching for all installed packages

**Example usage:**
```
$ zb outdated
==> Checking for outdated packages...
==> 3 outdated packages:

  git 2.43.0 â†’ 2.44.0
  node 20.11.0 â†’ 21.6.0
  python@3.11 3.11.7 â†’ 3.11.8

    â†’ Run zb upgrade to upgrade all

$ zb outdated --json
[
  {
    "name": "git",
    "installed_version": "2.43.0",
    "available_version": "2.44.0"
  }
]
```

### 6. Implemented Upgrade Command (Phase 1.3) âœ…

**Files modified:**
- `zb_io/src/install.rs` - Added `upgrade_one()`, `upgrade_all()` methods and `UpgradeResult` type
- `zb_io/src/lib.rs` - Exported `UpgradeResult`
- `zb_cli/src/main.rs` - Added `zb upgrade` command

**Features:**
- Upgrade all outdated packages: `zb upgrade`
- Upgrade specific package: `zb upgrade <formula>`
- Dry-run mode: `zb upgrade --dry-run`
- Progress display with download/unpack/link status
- Automatic removal of old version after successful upgrade
- Continues with other packages if one fails
- Displays summary of upgraded packages with old/new versions

**Implementation details:**
- Uses existing `get_outdated()` to find packages needing upgrade
- For each package: unlinks old version, installs new version, removes old keg
- Database automatically updated via INSERT OR REPLACE
- Reuses existing install flow with progress callbacks
- Version comparison using `Version::is_older_than()`

**Example usage:**
```
$ zb upgrade --dry-run
==> Would upgrade 2 packages:

  git 2.43.0 â†’ 2.44.0
  ripgrep 14.0.0 â†’ 14.1.0

$ zb upgrade
==> Upgrading 2 packages...

==> Upgrading git 2.43.0 â†’ 2.44.0...
    git              â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 10.5MB/10.5MB  0s
    git              âœ“ upgraded

==> Upgrading ripgrep 14.0.0 â†’ 14.1.0...
    ripgrep          âœ“ upgraded

==> Upgraded 2 packages in 3.45s:
    âœ“ git 2.43.0 â†’ 2.44.0
    âœ“ ripgrep 14.0.0 â†’ 14.1.0

$ zb upgrade git
==> git is already up to date.
```

**New tests (6 total):**
- `upgrade_installs_new_version_and_removes_old` - Tests full upgrade flow
- `upgrade_returns_none_when_up_to_date` - Tests no-op when current
- `upgrade_not_installed_returns_error` - Tests error on uninstalled package
- `upgrade_all_upgrades_multiple_packages` - Tests upgrading multiple packages at once
- `upgrade_all_empty_when_all_current` - Tests empty result when all up-to-date
- `upgrade_preserves_links` - Tests symlinks point to new version after upgrade

### 7. Implemented Pin/Unpin Commands (Phase 1.4) âœ…

**Files modified:**
- `zb_io/src/db.rs` - Added `pinned` column, migration, and pin/unpin/is_pinned/list_pinned methods
- `zb_io/src/install.rs` - Added `pin()`, `unpin()`, `is_pinned()`, `list_pinned()` methods; updated `get_outdated()` to filter pinned packages
- `zb_cli/src/main.rs` - Added `zb pin`, `zb unpin` commands and `zb list --pinned` flag

**Features:**
- Pin packages to prevent automatic upgrades: `zb pin <formula>`
- Unpin packages to allow upgrades: `zb unpin <formula>`
- List only pinned packages: `zb list --pinned`
- Pinned packages are excluded from `zb outdated` output
- Pinned packages are excluded from `zb upgrade` (automatic upgrade)
- Info command shows pinned status
- List command shows "(pinned)" marker for pinned packages
- Outdated command shows count of pinned packages not checked

**Database changes:**
- Added `pinned INTEGER NOT NULL DEFAULT 0` column to `installed_kegs` table
- Added migration to add column to existing databases

**Implementation details:**
- `get_outdated()` now filters out pinned packages by default
- `get_outdated_with_pinned(true)` can be used to include pinned packages
- Pin/unpin return NotInstalled error if package isn't installed
- Database migration runs automatically on schema init

**Example usage:**
```
$ zb pin git
==> Pinned git - it will not be upgraded

$ zb list
git 2.43.0 (pinned)
ripgrep 14.0.0

$ zb list --pinned
git 2.43.0 (pinned)

$ zb outdated
==> Checking for outdated packages...
==> 1 outdated package:

  ripgrep 14.0.0 â†’ 14.1.0

    â†’ Run zb upgrade to upgrade all
    â†’ 1 pinned packages not shown (use zb list --pinned to see them)

$ zb info git
Name:       git
Version:    2.43.0
Store key:  abc123def456
Installed:  ...
Pinned:     Yes

$ zb unpin git
==> Unpinned git - it will be upgraded when outdated
```

**New tests (7 total):**
- `db::pin_and_unpin_package` - Tests database-level pin/unpin
- `db::pin_nonexistent_package_returns_false` - Tests error handling
- `db::list_pinned_only_returns_pinned_packages` - Tests pinned filtering
- `install::pin_and_unpin_package` - Tests Installer-level pin/unpin
- `install::pin_not_installed_returns_error` - Tests NotInstalled error
- `install::pinned_packages_excluded_from_get_outdated` - Tests filtering in get_outdated()

### 8. Implemented Autoremove Command (Phase 1.5) âœ…

**Files modified:**
- `zb_io/src/db.rs` - Added `explicit` column, migration, and explicit tracking methods
- `zb_io/src/install.rs` - Added `find_orphans()`, `autoremove()`, and explicit marking methods
- `zb_cli/src/main.rs` - Added `zb autoremove` command

**Database changes:**
- Added `explicit INTEGER NOT NULL DEFAULT 1` column to `installed_kegs` table
- Migration automatically adds column to existing databases
- Existing packages default to explicit=1 (backward compatible)

**Features:**
- Track explicit vs dependency installs: root package marked explicit, dependencies marked as dependencies
- Find orphaned packages: `find_orphans()` identifies dependencies no longer needed
- Remove orphans: `zb autoremove` removes orphaned dependencies
- Dry-run mode: `zb autoremove --dry-run` shows what would be removed
- Mark explicit: `mark_explicit()` allows marking a dependency as explicitly wanted
- Prevents auto-removal of packages user explicitly wants to keep

**Implementation details:**
- `InstallPlan` now tracks `root_name` to identify the explicitly requested package
- `record_install()` takes `explicit` parameter to track install type
- `find_orphans()` computes required packages from all explicit installs
- Uses API to resolve transitive dependencies for each explicit package
- Orphans = dependencies that no explicit package requires

**Example usage:**
```
$ zb install foo    # foo's deps installed as dependencies

$ zb uninstall foo  # Remove foo but deps remain

$ zb autoremove --dry-run
==> Would remove 3 orphaned packages:

  libdep1
  libdep2
  libdep3

    â†’ Run zb autoremove to remove

$ zb autoremove
==> Removing 3 orphaned packages...

    âœ“ Removed libdep1
    âœ“ Removed libdep2
    âœ“ Removed libdep3

==> Removed 3 orphaned packages
```

**New tests (7 total):**
- `db::explicit_vs_dependency_tracking` - Tests database-level explicit tracking
- `db::mark_explicit_and_dependency` - Tests marking/unmarking packages
- `install::install_marks_root_as_explicit_and_deps_as_dependency` - Tests install tracking
- `install::find_orphans_returns_unused_dependencies` - Tests orphan detection
- `install::autoremove_removes_orphaned_dependencies` - Tests full autoremove flow
- `install::mark_explicit_prevents_autoremove` - Tests explicit marking prevents removal
- `install::mark_explicit_not_installed_returns_error` - Tests error handling

### 9. Implemented Shellenv Command (Phase 1.6) âœ…

**Files modified:**
- `zb_cli/src/main.rs` - Added `zb shellenv` command and shell-specific output generation

**Features:**
- Auto-detect shell type from $SHELL environment variable
- Support for multiple shells via `--shell` flag: bash, zsh, fish, csh/tcsh
- Outputs environment variables compatible with Homebrew:
  - `HOMEBREW_PREFIX` - the prefix directory
  - `HOMEBREW_CELLAR` - the Cellar directory
  - `PATH` - includes bin and sbin directories
  - `MANPATH` - includes man pages
  - `INFOPATH` - includes info pages
- Different syntax for different shells (export vs setenv vs set -gx)

**Implementation details:**
- `detect_shell()` - checks $SHELL for fish/csh/zsh, defaults to bash-compatible
- `generate_shellenv()` - generates shell-specific environment setup
- `print_shellenv()` - outputs the generated commands

**Example usage:**
```bash
# Auto-detect shell
$ zb shellenv
export HOMEBREW_PREFIX="/opt/zerobrew/prefix";
export HOMEBREW_CELLAR="/opt/zerobrew/prefix/Cellar";
export PATH="/opt/zerobrew/prefix/bin:/opt/zerobrew/prefix/sbin:$PATH";
export MANPATH="/opt/zerobrew/prefix/share/man:${MANPATH:-}";
export INFOPATH="/opt/zerobrew/prefix/share/info:${INFOPATH:-}";

# Add to shell rc file
$ eval "$(zb shellenv)"

# Specify shell explicitly
$ zb shellenv --shell fish
set -gx HOMEBREW_PREFIX "/opt/zerobrew/prefix";
set -gx HOMEBREW_CELLAR "/opt/zerobrew/prefix/Cellar";
set -gx PATH "/opt/zerobrew/prefix/bin" "/opt/zerobrew/prefix/sbin" $PATH;
...
```

**New tests (7 total):**
- `test_generate_shellenv_bash` - Tests bash output format
- `test_generate_shellenv_zsh` - Tests zsh output (same as bash)
- `test_generate_shellenv_fish` - Tests fish shell syntax
- `test_generate_shellenv_csh` - Tests csh/tcsh syntax
- `test_generate_shellenv_tcsh` - Tests tcsh (same as csh)
- `test_generate_shellenv_custom_prefix` - Tests with non-default prefix
- `test_generate_shellenv_unknown_shell_defaults_to_posix` - Tests fallback

### 10. Implemented Improved Info Command (Phase 1.7) âœ…

**Files modified:**
- `zb_cli/src/main.rs` - Enhanced `zb info` command with detailed output and JSON support
- `zb_core/src/formula.rs` - Added new fields to Formula struct (desc, homepage, license, caveats, keg_only, keg_only_reason, build_dependencies)
- `zb_io/src/db.rs` - Added `get_linked_files()` method
- `zb_io/src/install.rs` - Added `get_formula()`, `get_linked_files()`, `get_dependents()` methods

**Features:**
- Works for both installed and non-installed packages
- Shows detailed metadata from Homebrew API:
  - Description, homepage, license
  - Available version (highlights if update available)
  - Keg-only status with reason
  - Caveats (post-install notes)
- Shows installation state:
  - Installed version with pinned/dependency markers
  - Store key and installation timestamp
- Shows dependency information:
  - Lists all dependencies with âœ“/âœ— markers for installed status
  - Lists build dependencies
  - Lists reverse dependencies (packages that depend on this one)
- Shows linked files (symlinks in prefix)
- Supports `--json` flag for machine-readable output

**Formula struct enhancements:**
- Added `desc: Option<String>` - description
- Added `homepage: Option<String>` - project homepage
- Added `license: Option<String>` - license
- Added `build_dependencies: Vec<String>` - build-time dependencies
- Added `caveats: Option<String>` - post-install notes
- Added `keg_only: bool` - whether formula is keg-only
- Added `keg_only_reason: Option<KegOnlyReason>` - why it's keg-only
- Added `Default` derive for easier test construction

**Example usage:**
```
$ zb info git
==> git
Distributed revision control system
https://git-scm.com

Installed: 2.43.0

License: GPL-2.0-only

Dependencies:
  âœ“ gettext
  âœ“ pcre2
  âœ— curl (not installed)

Required by:
  gh
  lazygit

Linked files: (15 files)
  /opt/zerobrew/prefix/bin/git
  /opt/zerobrew/prefix/bin/git-receive-pack
  ...

Store key: abc123def456
Installed: 2024-01-26T10:30:00Z

==> Caveats
The Tcl/Tk GUIs (gitk, git-gui) are now in the `git-gui` formula.
```

**JSON output:**
```
$ zb info git --json
{
  "name": "git",
  "installed": true,
  "installed_version": "2.43.0",
  "available_version": "2.44.0",
  "description": "Distributed revision control system",
  "homepage": "https://git-scm.com",
  "license": "GPL-2.0-only",
  "dependencies": ["gettext", "pcre2", "curl"],
  "dependents": ["gh", "lazygit"],
  "linked_files": [...],
  "pinned": false,
  "explicit": true,
  "keg_only": false,
  "caveats": "The Tcl/Tk GUIs..."
}
```

---

## Phase 1 Complete! ðŸŽ‰

| Task | Status |
|------|--------|
| 1.1 Search command | âœ… Complete |
| 1.2 Outdated command | âœ… Complete |
| 1.3 Upgrade command | âœ… Complete |
| 1.4 Pin/unpin commands | âœ… Complete |
| 1.5 Autoremove command | âœ… Complete |
| 1.6 Shellenv command | âœ… Complete |
| 1.7 Improved info command | âœ… Complete |

---

## Test Results

All tests passing:
- 167 unit tests passed (37 zb_core + 123 zb_io + 7 CLI)
- 27 integration tests passed
- 4 tests ignored (require specific environment)

---

## Next Steps (Phase 2)

1. Implement tap support (2.1)
2. Implement formula Ruby parser (2.2)
3. Implement cleanup command (2.3)
4. Implement link/unlink commands (2.4)
5. Implement deps/uses commands (2.5)

---

## Notes

- Search command fetches ~7MB formula.json on first run (cached after)
- Outdated command fetches individual formula JSON for each installed package
- Consider adding `--json` flag to search for machine-readable output
- May want to add search filters (e.g., `--installed-only`)
- Upgrade command reuses install progress display for consistency
- Pin/unpin integrates with outdated/upgrade commands automatically
- Autoremove fetches formulas for all explicit packages to compute transitive deps
- Info command fetches from API for non-installed packages too
- Shellenv command compatible with Homebrew's output format
