# Zerobrew Development Progress

**Date**: 2026-01-26
**Branch**: linux-compat

---

## Session Summary

This session focused on PR review, code quality improvements, and starting Phase 1 implementation.

---

## Completed Tasks

### 1. Comprehensive PR Review
- Ran 4 specialized review agents in parallel (code-reviewer, test-analyzer, silent-failure-hunter, code-simplifier)
- Identified 5 important issues and 4 suggestions

### 2. Fixed All Review Issues

**Silent Failure Warnings Added:**
- `materialize.rs:468-471` - Warning when patchelf unavailable
- `materialize.rs:616-638` - Log patchelf failures with stderr
- `install.rs:91` - Warning when dependencies skipped (no compatible bottle)
- `install.rs:228` - Warning when formulas skipped (not found)
- `resolve.rs:71` - Warning when unavailable dependencies skipped
- `api.rs:112` - Warning on cache write failures

**Test Coverage Improvements:**
- Fixed `handles_broken_symlinks` test to assert behavior
- Fixed `handles_circular_symlinks` test to assert behavior
- Added `patches_rpath_without_changing_valid_interpreter` test
- Added `install_skips_macos_only_uses_from_macos_deps` test

**Code Quality Refactoring:**
- Extracted shared `patch_homebrew_path()` function (eliminates 35+ lines duplication)
- Added `WriteGuard` RAII pattern for permission handling (eliminates ~45 lines)
- Simplified `is_compatible_fallback_tag()` - flattened nested #[cfg] blocks
- Added `store_err()` helper for error mapping
- Refactored `create_or_find_patchable_binary()` with iterator combinators

### 3. Created Comprehensive Roadmap
- Wrote `ROADMAP.md` with 5 phases to full Homebrew replacement
- Phase 1 (v0.5): Daily Driver - search, outdated, upgrade, pin, autoremove, shellenv
- Phase 2 (v0.7): Power User - taps, formula parser, doctor
- Phase 3 (v0.8): Services - systemd/launchd
- Phase 4 (v1.0): Source builds
- Phase 5 (v1.x): Ecosystem - bundle, versioned formulas

### 4. Implemented Search Command (Phase 1.1) âœ…

**Files created/modified:**
- `zb_io/src/search.rs` (NEW) - Search module with relevance scoring
- `zb_io/src/api.rs` - Added `get_all_formulas()` and `FormulaInfo` type
- `zb_io/src/lib.rs` - Exported search module
- `zb_cli/src/main.rs` - Added `zb search` command

**Features:**
- Plain text search (matches name and description)
- Regex search with `/pattern/` syntax
- Relevance scoring (exact match > prefix > contains > description)
- Shows installed packages with âœ“ marker
- Excludes deprecated and disabled formulas
- Limits output to top 20 results

**Example usage:**
```
$ zb search git
==> Found 245 formulas:
âœ“ git 2.52.0
    Distributed revision control system
  git-absorb 0.8.0
    Automatic git commit --fixup
  ...

$ zb search '/python@3\.1[12]/'
==> Found 2 formulas:
  python@3.11 3.11.14
  python@3.12 3.12.12
```

---

## Commits Created

1. `d3cf8ed` - refactor: Improve error reporting and code quality
2. `f5ed76b` - docs: Add comprehensive roadmap for full Homebrew replacement

### 5. Implemented Outdated Command (Phase 1.2) âœ…

**Files created/modified:**
- `zb_core/src/version.rs` (NEW) - Version parsing and comparison
- `zb_core/src/lib.rs` - Exported version module
- `zb_io/src/install.rs` - Added `get_outdated()` method to Installer
- `zb_cli/src/main.rs` - Added `zb outdated` command
- `zb_cli/Cargo.toml` - Added serde_json dependency

**Features:**
- Compares installed package versions against latest API versions
- Handles Homebrew version formats including:
  - Simple versions: `1.2.3`
  - Rebuild suffixes: `1.0.0_1`
  - Prerelease: `1.0.0-beta` (properly sorts before `1.0.0`)
- Supports `--json` flag for machine-readable output
- Shows helpful upgrade hint in human-readable output
- Parallel API fetching for all installed packages

**Example usage:**
```
$ zb outdated
==> Checking for outdated packages...
==> 3 outdated packages:

  git 2.43.0 â†’ 2.44.0
  node 20.11.0 â†’ 21.6.0
  python@3.11 3.11.7 â†’ 3.11.8

    â†’ Run zb upgrade to upgrade all

$ zb outdated --json
[
  {
    "name": "git",
    "installed_version": "2.43.0",
    "available_version": "2.44.0"
  }
]
```

### 6. Implemented Upgrade Command (Phase 1.3) âœ…

**Files modified:**
- `zb_io/src/install.rs` - Added `upgrade_one()`, `upgrade_all()` methods and `UpgradeResult` type
- `zb_io/src/lib.rs` - Exported `UpgradeResult`
- `zb_cli/src/main.rs` - Added `zb upgrade` command

**Features:**
- Upgrade all outdated packages: `zb upgrade`
- Upgrade specific package: `zb upgrade <formula>`
- Dry-run mode: `zb upgrade --dry-run`
- Progress display with download/unpack/link status
- Automatic removal of old version after successful upgrade
- Continues with other packages if one fails
- Displays summary of upgraded packages with old/new versions

**Implementation details:**
- Uses existing `get_outdated()` to find packages needing upgrade
- For each package: unlinks old version, installs new version, removes old keg
- Database automatically updated via INSERT OR REPLACE
- Reuses existing install flow with progress callbacks
- Version comparison using `Version::is_older_than()`

**Example usage:**
```
$ zb upgrade --dry-run
==> Would upgrade 2 packages:

  git 2.43.0 â†’ 2.44.0
  ripgrep 14.0.0 â†’ 14.1.0

$ zb upgrade
==> Upgrading 2 packages...

==> Upgrading git 2.43.0 â†’ 2.44.0...
    git              â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 10.5MB/10.5MB  0s
    git              âœ“ upgraded

==> Upgrading ripgrep 14.0.0 â†’ 14.1.0...
    ripgrep          âœ“ upgraded

==> Upgraded 2 packages in 3.45s:
    âœ“ git 2.43.0 â†’ 2.44.0
    âœ“ ripgrep 14.0.0 â†’ 14.1.0

$ zb upgrade git
==> git is already up to date.
```

**New tests (6 total):**
- `upgrade_installs_new_version_and_removes_old` - Tests full upgrade flow
- `upgrade_returns_none_when_up_to_date` - Tests no-op when current
- `upgrade_not_installed_returns_error` - Tests error on uninstalled package
- `upgrade_all_upgrades_multiple_packages` - Tests upgrading multiple packages at once
- `upgrade_all_empty_when_all_current` - Tests empty result when all up-to-date
- `upgrade_preserves_links` - Tests symlinks point to new version after upgrade

### 7. Implemented Pin/Unpin Commands (Phase 1.4) âœ…

**Files modified:**
- `zb_io/src/db.rs` - Added `pinned` column, migration, and pin/unpin/is_pinned/list_pinned methods
- `zb_io/src/install.rs` - Added `pin()`, `unpin()`, `is_pinned()`, `list_pinned()` methods; updated `get_outdated()` to filter pinned packages
- `zb_cli/src/main.rs` - Added `zb pin`, `zb unpin` commands and `zb list --pinned` flag

**Features:**
- Pin packages to prevent automatic upgrades: `zb pin <formula>`
- Unpin packages to allow upgrades: `zb unpin <formula>`
- List only pinned packages: `zb list --pinned`
- Pinned packages are excluded from `zb outdated` output
- Pinned packages are excluded from `zb upgrade` (automatic upgrade)
- Info command shows pinned status
- List command shows "(pinned)" marker for pinned packages
- Outdated command shows count of pinned packages not checked

**Database changes:**
- Added `pinned INTEGER NOT NULL DEFAULT 0` column to `installed_kegs` table
- Added migration to add column to existing databases

**Implementation details:**
- `get_outdated()` now filters out pinned packages by default
- `get_outdated_with_pinned(true)` can be used to include pinned packages
- Pin/unpin return NotInstalled error if package isn't installed
- Database migration runs automatically on schema init

**Example usage:**
```
$ zb pin git
==> Pinned git - it will not be upgraded

$ zb list
git 2.43.0 (pinned)
ripgrep 14.0.0

$ zb list --pinned
git 2.43.0 (pinned)

$ zb outdated
==> Checking for outdated packages...
==> 1 outdated package:

  ripgrep 14.0.0 â†’ 14.1.0

    â†’ Run zb upgrade to upgrade all
    â†’ 1 pinned packages not shown (use zb list --pinned to see them)

$ zb info git
Name:       git
Version:    2.43.0
Store key:  abc123def456
Installed:  ...
Pinned:     Yes

$ zb unpin git
==> Unpinned git - it will be upgraded when outdated
```

**New tests (7 total):**
- `db::pin_and_unpin_package` - Tests database-level pin/unpin
- `db::pin_nonexistent_package_returns_false` - Tests error handling
- `db::list_pinned_only_returns_pinned_packages` - Tests pinned filtering
- `install::pin_and_unpin_package` - Tests Installer-level pin/unpin
- `install::pin_not_installed_returns_error` - Tests NotInstalled error
- `install::pinned_packages_excluded_from_get_outdated` - Tests filtering in get_outdated()

### 8. Implemented Autoremove Command (Phase 1.5) âœ…

**Files modified:**
- `zb_io/src/db.rs` - Added `explicit` column, migration, and explicit tracking methods
- `zb_io/src/install.rs` - Added `find_orphans()`, `autoremove()`, and explicit marking methods
- `zb_cli/src/main.rs` - Added `zb autoremove` command

**Database changes:**
- Added `explicit INTEGER NOT NULL DEFAULT 1` column to `installed_kegs` table
- Migration automatically adds column to existing databases
- Existing packages default to explicit=1 (backward compatible)

**Features:**
- Track explicit vs dependency installs: root package marked explicit, dependencies marked as dependencies
- Find orphaned packages: `find_orphans()` identifies dependencies no longer needed
- Remove orphans: `zb autoremove` removes orphaned dependencies
- Dry-run mode: `zb autoremove --dry-run` shows what would be removed
- Mark explicit: `mark_explicit()` allows marking a dependency as explicitly wanted
- Prevents auto-removal of packages user explicitly wants to keep

**Implementation details:**
- `InstallPlan` now tracks `root_name` to identify the explicitly requested package
- `record_install()` takes `explicit` parameter to track install type
- `find_orphans()` computes required packages from all explicit installs
- Uses API to resolve transitive dependencies for each explicit package
- Orphans = dependencies that no explicit package requires

**Example usage:**
```
$ zb install foo    # foo's deps installed as dependencies

$ zb uninstall foo  # Remove foo but deps remain

$ zb autoremove --dry-run
==> Would remove 3 orphaned packages:

  libdep1
  libdep2
  libdep3

    â†’ Run zb autoremove to remove

$ zb autoremove
==> Removing 3 orphaned packages...

    âœ“ Removed libdep1
    âœ“ Removed libdep2
    âœ“ Removed libdep3

==> Removed 3 orphaned packages
```

**New tests (7 total):**
- `db::explicit_vs_dependency_tracking` - Tests database-level explicit tracking
- `db::mark_explicit_and_dependency` - Tests marking/unmarking packages
- `install::install_marks_root_as_explicit_and_deps_as_dependency` - Tests install tracking
- `install::find_orphans_returns_unused_dependencies` - Tests orphan detection
- `install::autoremove_removes_orphaned_dependencies` - Tests full autoremove flow
- `install::mark_explicit_prevents_autoremove` - Tests explicit marking prevents removal
- `install::mark_explicit_not_installed_returns_error` - Tests error handling

### 9. Implemented Shellenv Command (Phase 1.6) âœ…

**Files modified:**
- `zb_cli/src/main.rs` - Added `zb shellenv` command and shell-specific output generation

**Features:**
- Auto-detect shell type from $SHELL environment variable
- Support for multiple shells via `--shell` flag: bash, zsh, fish, csh/tcsh
- Outputs environment variables compatible with Homebrew:
  - `HOMEBREW_PREFIX` - the prefix directory
  - `HOMEBREW_CELLAR` - the Cellar directory
  - `PATH` - includes bin and sbin directories
  - `MANPATH` - includes man pages
  - `INFOPATH` - includes info pages
- Different syntax for different shells (export vs setenv vs set -gx)

**Implementation details:**
- `detect_shell()` - checks $SHELL for fish/csh/zsh, defaults to bash-compatible
- `generate_shellenv()` - generates shell-specific environment setup
- `print_shellenv()` - outputs the generated commands

**Example usage:**
```bash
# Auto-detect shell
$ zb shellenv
export HOMEBREW_PREFIX="/opt/zerobrew/prefix";
export HOMEBREW_CELLAR="/opt/zerobrew/prefix/Cellar";
export PATH="/opt/zerobrew/prefix/bin:/opt/zerobrew/prefix/sbin:$PATH";
export MANPATH="/opt/zerobrew/prefix/share/man:${MANPATH:-}";
export INFOPATH="/opt/zerobrew/prefix/share/info:${INFOPATH:-}";

# Add to shell rc file
$ eval "$(zb shellenv)"

# Specify shell explicitly
$ zb shellenv --shell fish
set -gx HOMEBREW_PREFIX "/opt/zerobrew/prefix";
set -gx HOMEBREW_CELLAR "/opt/zerobrew/prefix/Cellar";
set -gx PATH "/opt/zerobrew/prefix/bin" "/opt/zerobrew/prefix/sbin" $PATH;
...
```

**New tests (7 total):**
- `test_generate_shellenv_bash` - Tests bash output format
- `test_generate_shellenv_zsh` - Tests zsh output (same as bash)
- `test_generate_shellenv_fish` - Tests fish shell syntax
- `test_generate_shellenv_csh` - Tests csh/tcsh syntax
- `test_generate_shellenv_tcsh` - Tests tcsh (same as csh)
- `test_generate_shellenv_custom_prefix` - Tests with non-default prefix
- `test_generate_shellenv_unknown_shell_defaults_to_posix` - Tests fallback

### 10. Implemented Improved Info Command (Phase 1.7) âœ…

**Files modified:**
- `zb_cli/src/main.rs` - Enhanced `zb info` command with detailed output and JSON support
- `zb_core/src/formula.rs` - Added new fields to Formula struct (desc, homepage, license, caveats, keg_only, keg_only_reason, build_dependencies)
- `zb_io/src/db.rs` - Added `get_linked_files()` method
- `zb_io/src/install.rs` - Added `get_formula()`, `get_linked_files()`, `get_dependents()` methods

**Features:**
- Works for both installed and non-installed packages
- Shows detailed metadata from Homebrew API:
  - Description, homepage, license
  - Available version (highlights if update available)
  - Keg-only status with reason
  - Caveats (post-install notes)
- Shows installation state:
  - Installed version with pinned/dependency markers
  - Store key and installation timestamp
- Shows dependency information:
  - Lists all dependencies with âœ“/âœ— markers for installed status
  - Lists build dependencies
  - Lists reverse dependencies (packages that depend on this one)
- Shows linked files (symlinks in prefix)
- Supports `--json` flag for machine-readable output

**Formula struct enhancements:**
- Added `desc: Option<String>` - description
- Added `homepage: Option<String>` - project homepage
- Added `license: Option<String>` - license
- Added `build_dependencies: Vec<String>` - build-time dependencies
- Added `caveats: Option<String>` - post-install notes
- Added `keg_only: bool` - whether formula is keg-only
- Added `keg_only_reason: Option<KegOnlyReason>` - why it's keg-only
- Added `Default` derive for easier test construction

**Example usage:**
```
$ zb info git
==> git
Distributed revision control system
https://git-scm.com

Installed: 2.43.0

License: GPL-2.0-only

Dependencies:
  âœ“ gettext
  âœ“ pcre2
  âœ— curl (not installed)

Required by:
  gh
  lazygit

Linked files: (15 files)
  /opt/zerobrew/prefix/bin/git
  /opt/zerobrew/prefix/bin/git-receive-pack
  ...

Store key: abc123def456
Installed: 2024-01-26T10:30:00Z

==> Caveats
The Tcl/Tk GUIs (gitk, git-gui) are now in the `git-gui` formula.
```

**JSON output:**
```
$ zb info git --json
{
  "name": "git",
  "installed": true,
  "installed_version": "2.43.0",
  "available_version": "2.44.0",
  "description": "Distributed revision control system",
  "homepage": "https://git-scm.com",
  "license": "GPL-2.0-only",
  "dependencies": ["gettext", "pcre2", "curl"],
  "dependents": ["gh", "lazygit"],
  "linked_files": [...],
  "pinned": false,
  "explicit": true,
  "keg_only": false,
  "caveats": "The Tcl/Tk GUIs..."
}
```

---

## Phase 1 Complete! ðŸŽ‰

| Task | Status |
|------|--------|
| 1.1 Search command | âœ… Complete |
| 1.2 Outdated command | âœ… Complete |
| 1.3 Upgrade command | âœ… Complete |
| 1.4 Pin/unpin commands | âœ… Complete |
| 1.5 Autoremove command | âœ… Complete |
| 1.6 Shellenv command | âœ… Complete |
| 1.7 Improved info command | âœ… Complete |

### 11. Implemented Tap Support (Phase 2.1) âœ…

**Files created/modified:**
- `zb_io/src/tap.rs` (NEW) - TapManager struct with tap operations
- `zb_io/src/lib.rs` - Exported tap module and types
- `zb_io/src/db.rs` - Added taps table and CRUD operations
- `zb_io/src/install.rs` - Integrated tap resolution into formula fetching
- `zb_core/src/formula.rs` - Added Serialize derive for caching formulas
- `zb_cli/src/main.rs` - Added `zb tap` and `zb untap` commands

**Database changes:**
- Added `taps` table with columns: name, url, added_at
- Records installed taps for persistence across sessions

**Features:**
- Add taps: `zb tap user/repo` - validates tap exists on GitHub, creates directory structure
- Remove taps: `zb untap user/repo` - removes tap directory and database record
- List taps: `zb tap` (no args) - shows all installed taps
- Install from taps: `zb install user/repo/formula` - explicit tap reference
- Automatic tap search: Dependencies are searched in homebrew/core first, then installed taps
- Formula caching: Fetched tap formulas are cached locally in ~/.zerobrew/taps/

**Tap directory structure:**
```
~/.zerobrew/taps/
â”œâ”€â”€ user/
â”‚   â””â”€â”€ repo/
â”‚       â”œâ”€â”€ .tap_info          # JSON metadata (name, url, added_at)
â”‚       â””â”€â”€ Formula/
â”‚           â”œâ”€â”€ pkg1.json      # Cached formula JSON
â”‚           â””â”€â”€ pkg2.json
```

**Implementation details:**
- TapFormula::parse() - Parses "user/repo/formula" format
- TapManager - Handles tap filesystem operations and GitHub fetching
- Installer::fetch_formula() - Tap-aware formula resolution
  1. Check if name is explicit tap reference (user/repo/formula)
  2. Try homebrew/core API
  3. Try each installed tap in order
- Database tracks installed taps for consistency

**Example usage:**
```bash
# Add a tap
$ zb tap homebrew/services
==> Tapping homebrew/services...

==> âœ“ Tapped homebrew/services

# List installed taps
$ zb tap
==> 1 installed taps:
    homebrew/services

# Install from a specific tap
$ zb install homebrew/services/brew-services

# Remove a tap
$ zb untap homebrew/services
==> Untapping homebrew/services...

==> âœ“ Untapped homebrew/services
```

**New tests (15 total):**
- TapFormula parsing tests (4)
- TapManager directory structure tests
- list_taps/is_tapped/remove_tap tests
- Formula caching tests
- Database tap CRUD tests (7)

---

## Test Results

All tests passing:
- 175 unit tests passed (51 zb_core + 164 zb_io + 11 zb_cli)
- 27 integration tests passed
- 4 tests ignored (require specific environment)

### 12. Implemented Formula Ruby Parser (Phase 2.2) âœ…

**Files created/modified:**
- `zb_core/src/formula_parser.rs` (NEW) - Ruby formula parser using tree-sitter
- `zb_core/src/lib.rs` - Exported formula_parser module
- `zb_core/Cargo.toml` - Added tree-sitter, tree-sitter-ruby, and regex dependencies
- `zb_io/src/tap.rs` - Integrated Ruby parsing into tap formula fetching

**Features:**
- Parse Ruby formula DSL using tree-sitter-ruby for robust AST handling
- Extract metadata: desc, homepage, license, version, url
- Parse dependencies: `depends_on`, `uses_from_macos` with build/test filtering
- Parse bottle blocks: platform-specific sha256 hashes and rebuild numbers
- Version extraction from URLs when not explicitly specified
- Automatic fallback from JSON to Ruby parsing when fetching tap formulas

**Supported Ruby DSL elements:**
```ruby
class Foo < Formula
  desc "Description"
  homepage "https://..."
  url "https://..."
  sha256 "..."
  license "MIT"
  version "1.2.3"   # Optional, can be extracted from URL

  depends_on "dep1"
  depends_on "dep2" => :build  # Build-only deps filtered
  uses_from_macos "zlib"
  uses_from_macos "flex" => :build  # Build-only excluded

  bottle do
    rebuild 1
    sha256 cellar: :any, arm64_sonoma: "..."
    sha256 cellar: :any_skip_relocation, x86_64_linux: "..."
  end
end
```

**Implementation details:**
- Uses tree-sitter for reliable Ruby parsing without executing Ruby code
- AST traversal extracts only the attributes needed for bottle installation
- Ignores `install`, `test`, `caveats`, `service` blocks (not needed for bottles)
- URL-based version extraction handles common patterns (vX.Y.Z, pkg-X.Y.Z, etc.)
- Bottle URLs generated in Homebrew GHCR format

**Tap integration:**
- When a tap formula isn't found as JSON, automatically tries Ruby parsing
- Fetches `.rb` files from common GitHub paths (Formula/, Formulas/, formula/)
- Tries multiple branches (HEAD, main, master)
- Successfully parsed formulas are cached as JSON for future use

**Example usage:**
```bash
# Now works with taps that only have Ruby formulas
$ zb tap homebrew/services
$ zb install homebrew/services/some-formula  # Parses Ruby if no JSON
```

**New tests (14 unit tests + 4 integration tests):**
- `parse_simple_formula` - Basic formula parsing
- `parse_formula_with_build_deps` - Build dependency filtering
- `parse_formula_with_uses_from_macos` - macOS system deps
- `parse_formula_with_rebuild` - Bottle rebuild numbers
- `parse_formula_with_explicit_version` - Version override
- `parse_formula_missing_class_fails` - Error handling
- `parse_multiple_bottle_platforms` - Multi-platform bottles
- `parse_formula_with_multiple_deps` - Complex dependency trees
- `parse_formula_no_bottle_is_ok` - Formulas without bottles
- `bottle_url_contains_formula_name` - URL generation
- `version_extraction_handles_jq_style` - URL version patterns
- `version_extraction_handles_python_style` - More URL patterns
- `parse_uses_from_macos_build_only_excluded` - Build-time filtering
- `extract_version_from_url_works` - Version regex testing
- `fetch_ruby_formula_parses_and_caches` - Tap integration
- `ruby_formula_parsing_integration` - Real-world patterns
- `ruby_formula_with_rebuild` - Rebuild version calculation

---

### 13. Enhanced Cleanup Command with HTTP Cache (Phase 2.3) âœ…

**Files modified:**
- `zb_io/src/cache.rs` - Added HTTP cache cleanup methods
- `zb_io/src/api.rs` - Added API client cache cleanup methods
- `zb_io/src/install.rs` - Added HTTP cache cleanup to CleanupResult and cleanup methods
- `zb_cli/src/main.rs` - Updated CLI to show HTTP cache cleanup stats

**Features:**
- HTTP cache cleanup with age-based pruning: `zb cleanup --prune=30`
- Clear all unused HTTP cache: `zb cleanup` (no prune days)
- Dry-run mode shows HTTP cache entries to be removed
- Tracks HTTP cache entries removed and bytes freed
- Existing blob cache, store, temp file, and lock cleanup still functional

**HTTP cache cleanup methods added to ApiCache:**
- `cleanup_older_than(days)` - Remove entries older than N days
- `clear()` - Remove all entries
- `count()` - Count total entries
- `count_older_than(days)` - Count old entries
- `total_body_size()` - Get total cache size
- `body_size_older_than(days)` - Get size of old entries

**Example usage:**
```bash
# Dry run - see what would be cleaned
$ zb cleanup --dry-run
==> Checking for files to clean up...
==> Would remove:

  3 unreferenced store entries
  5 cached bottle downloads
  12 cached API responses

  Total: 45.2 MB

    â†’ Run zb cleanup to clean up

# Clean with 30-day prune threshold
$ zb cleanup --prune=30
==> Cleaning up...

    âœ“ Removed 3 unreferenced store entries
    âœ“ Removed 5 cached bottle downloads
    âœ“ Removed 8 cached API responses
    âœ“ Removed 2 temp files/directories

==> Freed 45.2 MB

# Clean everything unused
$ zb cleanup
==> Cleaning up...

    âœ“ Removed 12 cached API responses

==> Freed 2.1 MB
```

**New tests (23 total):**

*HTTP Cache tests (from earlier):*
- `count_returns_number_of_entries` - Tests counting cache entries
- `clear_removes_all_entries` - Tests clearing all entries
- `total_body_size_returns_sum_of_body_lengths` - Tests size calculation
- `cleanup_older_than_removes_old_entries` - Tests age-based cleanup
- `count_older_than_returns_count_of_old_entries` - Tests counting old entries
- `body_size_older_than_returns_size_of_old_entries` - Tests size of old entries

*BlobCache cleanup tests:*
- `list_blobs_returns_all_blobs` - Tests listing all cached blobs
- `total_size_returns_correct_size` - Tests blob cache size calculation
- `remove_blobs_except_keeps_specified` - Tests keeping only specified blobs
- `cleanup_temp_files_removes_part_files` - Tests temp file cleanup

*Store cleanup tests:*
- `list_entries_returns_all_store_entries` - Tests listing store entries
- `cleanup_stale_locks_removes_orphaned_locks` - Tests stale lock cleanup
- `cleanup_temp_dirs_removes_stale_temp_directories` - Tests temp dir cleanup
- `total_size_returns_correct_value` - Tests store size calculation

*Installer cleanup integration tests:*
- `cleanup_removes_unused_blobs_and_store_entries` - Full cleanup flow
- `cleanup_dry_run_does_not_remove_files` - Dry run doesn't modify
- `cleanup_keeps_installed_package_blobs` - Keeps blobs for installed packages

*CLI tests:*
- `test_format_bytes_bytes` - Tests byte formatting < 1KB
- `test_format_bytes_kilobytes` - Tests KB formatting
- `test_format_bytes_megabytes` - Tests MB formatting
- `test_format_bytes_gigabytes` - Tests GB formatting

### 14. Implemented Link/Unlink Commands (Phase 2.4) âœ…

**Files modified:**
- `zb_io/src/install.rs` - Added `link()`, `unlink()`, `is_linked()`, `keg_path()` methods and `LinkResult` type
- `zb_io/src/lib.rs` - Exported `LinkResult` type
- `zb_io/src/db.rs` - Added `clear_linked_files()` and non-transactional `record_linked_file()` methods
- `zb_cli/src/main.rs` - Added `zb link` and `zb unlink` commands with `--force` and `--overwrite` flags

**Features:**
- Link keg executables: `zb link <formula>` - Creates symlinks in prefix/bin and prefix/opt
- Unlink keg executables: `zb unlink <formula>` - Removes symlinks but keeps package installed
- Force link keg-only formulas: `zb link --force <formula>` - Links formulas normally not linked
- Overwrite conflicting symlinks: `zb link --overwrite <formula>` - Overwrites existing symlinks
- Status tracking: `is_linked()` method checks if a keg is currently linked
- Database tracking: Links are recorded in keg_files table for accurate tracking

**Link command behavior:**
- Checks if package is installed before linking
- For keg-only formulas, shows warning and requires `--force` flag
- Returns `already_linked: true` if keg is already linked (no changes made)
- Creates symlinks via underlying Linker and records them in database
- Handles link conflicts with helpful error messages suggesting `--overwrite`

**Unlink command behavior:**
- Checks if package is installed before unlinking
- Removes all symlinks for the keg from prefix
- Clears linked file records from database
- Keeps package installed in Cellar

**Example usage:**
```bash
# Link a package that was installed without linking
$ zb link git
==> Linking git...
==> âœ“ Linked 15 files for git

# Try to link a keg-only formula (e.g., openssl)
$ zb link openssl@3
Warning: openssl@3 is keg-only, which means it was not symlinked into /opt/zerobrew/prefix

If you need to have openssl@3 first in your PATH, run:
  zb link --force openssl@3

# Force link a keg-only formula
$ zb link --force openssl@3
==> Linking openssl@3...
==> âœ“ Linked 42 files for openssl@3
    â†’ This is a keg-only formula - it was linked with --force

# Unlink a package (keeps it installed)
$ zb unlink git
==> Unlinking git...
==> âœ“ Unlinked 15 files for git

# Package is still installed after unlinking
$ zb list
git 2.44.0 (not linked)
```

**New tests (15 total):**

*Installer tests (8):*
- `link_creates_symlinks` - Tests linking a package not initially linked
- `unlink_removes_symlinks_but_keeps_installed` - Tests unlink keeps package in Cellar
- `link_already_linked_returns_already_linked` - Tests idempotent linking
- `link_not_installed_returns_error` - Tests NotInstalled error
- `unlink_not_installed_returns_error` - Tests NotInstalled error
- `unlink_then_relink_works` - Tests full unlink/relink cycle
- `is_linked_returns_false_for_uninstalled_package` - Tests is_linked on nonexistent package

*Database tests (4):*
- `clear_linked_files_removes_all_links_for_package` - Tests clearing links
- `clear_linked_files_returns_zero_for_no_links` - Tests empty case
- `record_linked_file_non_transactional` - Tests non-tx version of record_linked_file
- `record_linked_file_non_transactional_replaces_existing` - Tests upsert behavior

---

### 15. Implemented Deps/Uses Commands (Phase 2.5) âœ…

**Files modified:**
- `zb_io/src/install.rs` - Added `get_deps()`, `get_deps_tree()`, `get_uses()` methods and `DepsTree` type
- `zb_io/src/lib.rs` - Exported `DepsTree` type
- `zb_cli/src/main.rs` - Added `zb deps` and `zb uses` commands with tree view support

**Features:**
- Show dependencies: `zb deps <formula>` - Lists all dependencies
- Tree view: `zb deps --tree <formula>` - Shows hierarchical dependency tree
- Installed only: `zb deps --installed <formula>` - Only show installed deps
- All transitive: `zb deps -1 <formula>` or `zb deps --all <formula>` - Show all transitive deps
- Reverse dependencies: `zb uses <formula>` - Shows packages that depend on this formula
- Recursive uses: `zb uses --recursive <formula>` - Shows transitive reverse deps

**Deps command options:**
- `--tree` - Display as ASCII tree with installation status markers (âœ“/âœ—)
- `--installed` - Filter to only installed dependencies
- `--all` or `-1` - Include all transitive dependencies (not just direct)

**Uses command options:**
- `--installed` - Only check installed packages (default behavior)
- `--recursive` - Include packages that transitively depend on this formula

**Example usage:**
```bash
# Show direct dependencies
$ zb deps git
==> Dependencies for git:
  âœ“ gettext
  âœ“ pcre2
  âœ— curl

# Show as tree
$ zb deps --tree openssl@3
==> Dependencies for openssl@3 (tree view):
âœ“ openssl@3
â”œâ”€â”€ âœ“ ca-certificates
â””â”€â”€ âœ— zlib

# Show what uses this formula
$ zb uses gettext
==> 3 installed formulas use gettext:
  git
  wget
  glib
```

**New tests (3 total):**
- `get_deps_returns_direct_dependencies` - Tests flat dependency listing
- `get_leaves_returns_packages_not_depended_on` - Tests orphan detection
- `doctor_checks_run_without_panic` - Tests doctor runs without errors

### 16. Implemented Leaves Command (Phase 2.6) âœ…

**Files modified:**
- `zb_io/src/install.rs` - Added `get_leaves()` method
- `zb_cli/src/main.rs` - Added `zb leaves` command

**Features:**
- List leaf packages: `zb leaves` - Shows installed packages not depended on by others
- Identifies top-level packages the user explicitly installed
- Useful for finding packages that can be safely removed

**Implementation details:**
- Fetches formula metadata for all installed packages
- Collects all dependencies across all installed packages
- Returns packages that are not in any dependency list
- Sorted alphabetically for consistent output

**Example usage:**
```bash
$ zb leaves
==> Finding leaf packages...
==> 5 leaf packages (not dependencies of other installed packages):

  git
  neovim
  ripgrep
  tmux
  zsh
```

### 17. Implemented Doctor Command (Phase 2.7) âœ…

**Files modified:**
- `zb_io/src/install.rs` - Added `doctor()` method and `DoctorCheck`, `DoctorResult`, `DoctorStatus` types
- `zb_io/src/lib.rs` - Exported doctor-related types
- `zb_cli/src/main.rs` - Added `zb doctor` command

**Features:**
- Diagnostic checks for common installation issues
- Status levels: Ok (âœ“), Warning (!), Error (âœ—)
- Suggested fixes for each issue found
- Summary of errors and warnings at the end

**Diagnostic checks performed:**
1. **Prefix writable** - Checks if prefix directory exists and is writable
2. **Cellar structure** - Validates installed packages exist in Cellar
3. **Database integrity** - Checks for orphaned database entries
4. **Broken symlinks** - Finds broken symlinks in bin/
5. **Missing dependencies** - Identifies installed packages with missing deps
6. **patchelf installed** (Linux only) - Checks for binary patching tool
7. **Directory permissions** - Validates write permissions on key directories

**Example usage:**
```bash
$ zb doctor
==> Running diagnostics...

âœ“ Prefix directory exists and is writable
âœ“ Cellar structure is valid
âœ“ Database is consistent
âœ“ No broken symlinks in bin/
âœ“ All dependencies are installed
âœ“ patchelf is installed (patchelf 0.18.0)
âœ“ All directories have correct permissions

==> Your system is ready to brew!

# With issues:
$ zb doctor
==> Running diagnostics...

âœ“ Prefix directory exists and is writable
âœ— Installed package 'foo' missing from Cellar at /opt/zerobrew/prefix/Cellar/foo/1.0.0
    â†’ Run: zb uninstall foo && zb install foo
! 'bar' is missing dependencies: libdep
    â†’ Run: zb install libdep

==> 1 error found
==> 1 warning found
```

**New tests (1 total):**
- `doctor_checks_run_without_panic` - Ensures doctor runs successfully on fresh install

---

## Phase 2 Complete! ðŸŽ‰

| Task | Status |
|------|--------|
| 2.1 Tap support | âœ… Complete |
| 2.2 Formula Ruby parser | âœ… Complete |
| 2.3 Cleanup command | âœ… Complete |
| 2.4 Link/unlink commands | âœ… Complete |
| 2.5 Deps/uses commands | âœ… Complete |
| 2.6 Leaves command | âœ… Complete |
| 2.7 Doctor command | âœ… Complete |

---

## Next Steps (Phase 3)

Phase 3 focuses on service management:
1. Implement `zb services list` - Show running services
2. Implement `zb services start/stop/restart` - Control services
3. Add systemd integration for Linux
4. Add launchd integration for macOS

---

## Notes

- Search command fetches ~7MB formula.json on first run (cached after)
- Outdated command fetches individual formula JSON for each installed package
- Consider adding `--json` flag to search for machine-readable output
- May want to add search filters (e.g., `--installed-only`)
- Upgrade command reuses install progress display for consistency
- Pin/unpin integrates with outdated/upgrade commands automatically
- Autoremove fetches formulas for all explicit packages to compute transitive deps
- Info command fetches from API for non-installed packages too
- Shellenv command compatible with Homebrew's output format
- Ruby formula parser uses tree-sitter for reliable parsing without Ruby interpreter
- Tap support now works with both JSON and Ruby formulas
- Cleanup command now includes HTTP cache cleanup with prune days support
- Link/unlink commands allow fine-grained control over symlink creation
